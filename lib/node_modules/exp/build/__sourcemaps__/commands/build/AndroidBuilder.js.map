{"version":3,"sources":["commands/build/AndroidBuilder.js"],"names":["AndroidBuilder","checkStatus","collectAndValidateCredentials","publish","publishedExpIds","build","getPublishInfoAsync","projectDir","args","username","remotePackageName","experienceName","remoteFullPackageName","credentialMetadata","platform","localKeystorePath","resolve","localKeystoreExists","existsSync","warn","red","questions","type","name","message","prompt","answers","confirm","removeCredentialsForPlatform","credentialsExistForPlatformAsync","credentials","options","clearCredentials","console","log","choices","value","validate","keystorePath","stat","keystorePathStats","isFile","filter","isAbsolute","when","uploadKeystore","val","password","_clearCredentials","keystoreAlias","keystorePassword","keyPassword","readFile","keystoreData","keystore","toString","updateCredentialsForPlatform"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIA;AAAA;AAAA;;AACA;;;;AACA;AAAA;AAAA;;;;AACA;AAAA;AAAA;;;;AACA;AAAA;AAAA;;;;AACA;AAAA;AAAA;;;;AACA;AAAA;AAAA;;;;AAEA;AAAA;AAAA;;;;IAIqBA,c;;;;;;;;;;;;;;;;;;uBAGX,KAAKC,WAAL,E;;;;uBAEA,KAAKC,6BAAL,E;;;;uBAEwB,KAAKC,OAAL,E;;;AAAxBC,+B;;uBAEA,KAAKC,KAAL,CAAWD,eAAX,EAA4B,SAA5B,C;;;;;;;;;;;;;;;;;;;;;;;;;;;uBAMI,0BAAIE,mBAAJ,CAAwB,KAAKC,UAA7B,C;;;;mCADRC,I;AAAQC,wB,cAAAA,Q;AAAUC,iC,cAAAA,iB;AAA0CC,8B,cAAvBC,qB;AAGjCC,kC,GAAqB;AACzBJ,oCADyB;AAEzBE,gDAFyB;AAGzBG,4BAAU;AAHe,iB;AAMrBC,iC,GAAoB,cAAKC,OAAL,CAAgBN,iBAAhB,U;AACpBO,mC,GAAsB,sCAAGC,UAAH,CAAcH,iBAAd,C;;AAC5B,oBAAIE,mBAAJ,EAAyB;AACvB,gDAAIE,IAAJ,CACE,kIADF;AAGD,iBAJD,MAIO;AACL,gDAAIA,IAAJ,CAAS,gEAAT;AACA,gDAAIA,IAAJ,CAAS,6DAAT;AACA,gDAAIA,IAAJ,CACE,uGADF;AAGD;AACD,8CAAIA,IAAJ,0EACyE,kCAAMC,GAAN,CACrE,oCADqE,CADzE;AAKA,8CAAID,IAAJ,CACE,6GADF;AAGA,8CAAIA,IAAJ,CACE,2JADF;AAGIE,yB,GAAY,CACd;AACEC,wBAAM,SADR;AAEEC,wBAAM,SAFR;AAGEC,2BAAS;AAHX,iBADc,C;;uBAQM,wCAASC,MAAT,CAAgBJ,SAAhB,C;;;AAAhBK,uB;;qBAEFA,QAAQC,O;;;;;;uBACJ,kCAAYC,4BAAZ,CAAyC,SAAzC,EAAoDf,kBAApD,C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;uBAOE,0BAAIP,mBAAJ,CAAwB,KAAKC,UAA7B,C;;;;mCADRC,I;AAAQC,wB,cAAAA,Q;AAAiCE,8B,cAAvBC,qB;AAGdC,kC,GAAqB;AACzBJ,oCADyB;AAEzBE,gDAFyB;AAGzBG,4BAAU;AAHe,iB;;uBAMoB,kCAAYe,gCAAZ,CAC7ChB,kBAD6C,C;;;AAAzCiB,2B;;sBAIF,KAAKC,OAAL,CAAaC,gBAAb,IAAiC,CAACF,W;;;;;AACpCG,wBAAQC,GAAR,CAAY,EAAZ;AACMb,yB,GAAY,CAChB;AACEC,wBAAM,SADR;AAEEC,wBAAM,gBAFR;AAGEC,6JAHF;AAIEW,2BAAS,CACP,EAAEZ,MAAM,8BAAR,EAAwCa,OAAO,KAA/C,EADO,EAEP,EAAEb,MAAM,mCAAR,EAA6Ca,OAAO,IAApD,EAFO;AAJX,iBADgB,EAUhB;AACEd,wBAAM,OADR;AAEEC,wBAAM,cAFR;AAGEC,8CAHF;AAIEa;AAAA,+JAAU,kBAAMC,YAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qCAE0B,sCAAGC,IAAH,CAAQD,YAAR,CAF1B;;AAAA;AAEAE,+CAFA;AAAA,gEAGCA,kBAAkBC,MAAlB,EAHD;;AAAA;AAAA;AAAA;;AAKN;AACAR,sCAAQC,GAAR,CAAY,wBAAZ;AANM,gEAOC,KAPD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAAV;;AAAA;AAAA;AAAA;AAAA,qBAJF;AAcEQ,0BAAQ,8BAAgB;AACtBJ,mCAAe,+CAAUA,YAAV,CAAf;AACA,wBAAI,CAAC,cAAKK,UAAL,CAAgBL,YAAhB,CAAL,EAAoC;AAClCA,qCAAe,cAAKtB,OAAL,CAAasB,YAAb,CAAf;AACD;AACD,2BAAOA,YAAP;AACD,mBApBH;AAqBEM,wBAAM;AAAA,2BAAWlB,QAAQmB,cAAnB;AAAA;AArBR,iBAVgB,EAiChB;AACEvB,wBAAM,OADR;AAEEC,wBAAM,eAFR;AAGEC,4CAHF;AAIEa,4BAAU;AAAA,2BAAOS,QAAQ,EAAf;AAAA,mBAJZ;AAKEF,wBAAM;AAAA,2BAAWlB,QAAQmB,cAAnB;AAAA;AALR,iBAjCgB,EAwChB;AACEvB,wBAAM,UADR;AAEEC,wBAAM,kBAFR;AAGEC,+CAHF;AAIEa,4BAAU;AAAA,2BAAOS,QAAQ,EAAf;AAAA,mBAJZ;AAKEF,wBAAM;AAAA,2BAAWlB,QAAQmB,cAAnB;AAAA;AALR,iBAxCgB,EA+ChB;AACEvB,wBAAM,UADR;AAEEC,wBAAM,aAFR;AAGEC,0CAHF;AAIEa,4BAAU,kBAACU,QAAD,EAAWrB,OAAX,EAAuB;AAC/B,wBAAIqB,aAAa,EAAjB,EAAqB;AACnB,6BAAO,KAAP;AACD;AACD;AACA,2BAAO,IAAP;AACD,mBAVH;AAWEH,wBAAM;AAAA,2BAAWlB,QAAQmB,cAAnB;AAAA;AAXR,iBA/CgB,C;;uBA8DI,wCAASpB,MAAT,CAAgBJ,SAAhB,C;;;AAAhBK,uB;;oBAEDA,QAAQmB,c;;;;;qBACP,KAAKd,OAAL,CAAaC,gB;;;;;;uBACT,KAAKgB,iBAAL,E;;;;;;AAIAV,4B,GAA+DZ,O,CAA/DY,Y,EAAcW,a,GAAiDvB,O,CAAjDuB,a,EAAeC,gB,GAAkCxB,O,CAAlCwB,gB,EAAkBC,W,GAAgBzB,O,CAAhByB,W;;AAEvD;;;uBAC2B,sCAAGC,QAAH,CAAYd,YAAZ,C;;;AAArBe,4B;AAEAvB,4B,GAAkC;AACtCwB,4BAAUD,aAAaE,QAAb,CAAsB,QAAtB,CAD4B;AAEtCN,8CAFsC;AAGtCC,oDAHsC;AAItCC;AAJsC,iB;;uBAMlC,kCAAYK,4BAAZ,CAAyC,SAAzC,EAAoD1B,YAApD,EAAiEjB,kBAAjE,C;;;;;;;;;;;;;;;;;;;;kBAhKOb,c","file":"../../../commands/build/AndroidBuilder.js","sourcesContent":["/**\n * @flow\n */\n\nimport fs from 'fs-extra';\nimport path from 'path';\nimport inquirer from 'inquirer';\nimport untildify from 'untildify';\nimport { Exp, Credentials } from 'xdl';\nimport chalk from 'chalk';\nimport log from '../../log';\n\nimport BaseBuilder from './BaseBuilder';\n\nimport type { AndroidCredentials } from 'xdl/build/credentials';\n\nexport default class AndroidBuilder extends BaseBuilder {\n  async run() {\n    // Check the status of any current builds\n    await this.checkStatus();\n    // Check for existing credentials, collect any missing credentials, and validate them\n    await this.collectAndValidateCredentials();\n    // Publish the current experience\n    const publishedExpIds = await this.publish();\n    // Initiate a build\n    await this.build(publishedExpIds, 'android');\n  }\n\n  async _clearCredentials() {\n    const {\n      args: { username, remotePackageName, remoteFullPackageName: experienceName },\n    } = await Exp.getPublishInfoAsync(this.projectDir);\n\n    const credentialMetadata = {\n      username,\n      experienceName,\n      platform: 'android',\n    };\n\n    const localKeystorePath = path.resolve(`${remotePackageName}.jks`);\n    const localKeystoreExists = fs.existsSync(localKeystorePath);\n    if (localKeystoreExists) {\n      log.warn(\n        'Detected a local copy of an Android keystore. Please double check that the keystore is up to date so it can be used as a backup.'\n      );\n    } else {\n      log.warn('Cannot find a local keystore in the current project directory.');\n      log.warn('Can you make sure you have a local backup of your keystore?');\n      log.warn(\n        'You can fetch an updated version from our servers by using `exp fetch:android:keystore [project-dir]`'\n      );\n    }\n    log.warn(\n      `Clearing your Android build credentials from our build servers is a ${chalk.red(\n        'PERMANENT and IRREVERSIBLE action.'\n      )}`\n    );\n    log.warn(\n      'Android keystores must be identical to the one previously used to submit your app to the Google Play Store.'\n    );\n    log.warn(\n      'Please read https://docs.expo.io/versions/latest/guides/building-standalone-apps.html#if-you-choose-to-build-for-android for more info before proceeding.'\n    );\n    let questions = [\n      {\n        type: 'confirm',\n        name: 'confirm',\n        message: 'Permanently delete the Android build credentials from our servers?',\n      },\n    ];\n\n    const answers = await inquirer.prompt(questions);\n\n    if (answers.confirm) {\n      await Credentials.removeCredentialsForPlatform('android', credentialMetadata);\n    }\n  }\n\n  async collectAndValidateCredentials() {\n    const {\n      args: { username, remoteFullPackageName: experienceName },\n    } = await Exp.getPublishInfoAsync(this.projectDir);\n\n    const credentialMetadata = {\n      username,\n      experienceName,\n      platform: 'android',\n    };\n\n    const credentials: ?AndroidCredentials = await Credentials.credentialsExistForPlatformAsync(\n      credentialMetadata\n    );\n\n    if (this.options.clearCredentials || !credentials) {\n      console.log('');\n      const questions = [\n        {\n          type: 'rawlist',\n          name: 'uploadKeystore',\n          message: `Would you like to upload a keystore or have us generate one for you?\\nIf you don't know what this means, let us handle it! :)\\n`,\n          choices: [\n            { name: 'Let Expo handle the process!', value: false },\n            { name: 'I want to upload my own keystore!', value: true },\n          ],\n        },\n        {\n          type: 'input',\n          name: 'keystorePath',\n          message: `Path to keystore:`,\n          validate: async keystorePath => {\n            try {\n              const keystorePathStats = await fs.stat(keystorePath);\n              return keystorePathStats.isFile();\n            } catch (e) {\n              // file does not exist\n              console.log('\\nFile does not exist.');\n              return false;\n            }\n          },\n          filter: keystorePath => {\n            keystorePath = untildify(keystorePath);\n            if (!path.isAbsolute(keystorePath)) {\n              keystorePath = path.resolve(keystorePath);\n            }\n            return keystorePath;\n          },\n          when: answers => answers.uploadKeystore,\n        },\n        {\n          type: 'input',\n          name: 'keystoreAlias',\n          message: `Keystore Alias:`,\n          validate: val => val !== '',\n          when: answers => answers.uploadKeystore,\n        },\n        {\n          type: 'password',\n          name: 'keystorePassword',\n          message: `Keystore Password:`,\n          validate: val => val !== '',\n          when: answers => answers.uploadKeystore,\n        },\n        {\n          type: 'password',\n          name: 'keyPassword',\n          message: `Key Password:`,\n          validate: (password, answers) => {\n            if (password === '') {\n              return false;\n            }\n            // Todo validate keystore passwords\n            return true;\n          },\n          when: answers => answers.uploadKeystore,\n        },\n      ];\n\n      const answers = await inquirer.prompt(questions);\n\n      if (!answers.uploadKeystore) {\n        if (this.options.clearCredentials) {\n          await this._clearCredentials();\n        }\n        return; // just continue\n      } else {\n        const { keystorePath, keystoreAlias, keystorePassword, keyPassword } = answers;\n\n        // read the keystore\n        const keystoreData = await fs.readFile(keystorePath);\n\n        const credentials: AndroidCredentials = {\n          keystore: keystoreData.toString('base64'),\n          keystoreAlias,\n          keystorePassword,\n          keyPassword,\n        };\n        await Credentials.updateCredentialsForPlatform('android', credentials, credentialMetadata);\n      }\n    }\n  }\n}\n"],"sourceRoot":"/Users/brentvatne/universe/dev/exp/src"}