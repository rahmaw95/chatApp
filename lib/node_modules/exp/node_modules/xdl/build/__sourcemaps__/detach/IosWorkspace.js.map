{"version":3,"sources":["detach/IosWorkspace.js"],"names":["async","sdkVersion","versions","await","Versions","versionsAsync","let","sdkVersionConfig","sdkVersions","process","env","EXPO_VIEW_DIR","Error","iosVersion","iosExpoViewUrl","iosClientVersion","_getVersionedExpoKitConfigAsync","context","type","path","join","data","expoSourcePath","expoRootTemplateDirectory","projectPath","isDirectory","mkdirp","sync","console","log","Api","downloadAsync","extract","_getOrCreateTemplateDirectoryAsync","projectDirectory","projectName","gitIgnorePath","fs","existsSync","rimraf","e","filesToTransform","bundleIdentifier","exp","ios","Promise","all","map","fileName","transformFileContentsAsync","fileString","replace","filesToMove","forEach","destFileName","dirname","extname","spawnAsync","_renameAndMoveProjectFilesAsync","configFilePath","standaloneSdkVersion","isMultipleVersion","IosPlist","modifyAsync","versionConfig","detachedNativeVersions","shell","kernel","_configureVersionsPlistAsync","iosProjectDirectory","getPaths","templatePodfilePath","reactNativeDependencyPath","relative","podfileSubstitutions","TARGET_NAME","REACT_NATIVE_PATH","EXPOKIT_TAG","EXPOKIT_TAG_IOS","EXPOKIT_PATH","renderPodfileAsync","_renderPodfileFromTemplateAsync","config","version","newestSdkVersionAsync","supportingDirectory","Utils","ncpAsync","rimrafDontThrow","cleanBackupAsync","createDetachedAsync","addDetachedConfigToExp","warn","publishBundlePath","publishManifestPath","intermediatesDirectory","isAnonymous","name","projectNameLabel","toLowerCase","archivePath","build","workspaceSourcePath"],"mappings":"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","file":"../../detach/IosWorkspace.js","sourcesContent":["/**\n * @flow\n */\nimport fs from 'fs';\nimport mkdirp from 'mkdirp';\nimport path from 'path';\nimport rimraf from 'rimraf';\n\nimport Api from '../Api';\nimport {\n  isDirectory,\n  rimrafDontThrow,\n  spawnAsync,\n  transformFileContentsAsync,\n} from './ExponentTools';\nimport { renderPodfileAsync } from './IosPodsTools.js';\nimport * as IosPlist from './IosPlist';\nimport * as Utils from '../Utils';\nimport StandaloneContext from './StandaloneContext';\nimport * as Versions from '../Versions';\n\nasync function _getVersionedExpoKitConfigAsync(sdkVersion: string): any {\n  const versions = await Versions.versionsAsync();\n  let sdkVersionConfig = versions.sdkVersions[sdkVersion];\n  if (!sdkVersionConfig) {\n    if (process.env.EXPO_VIEW_DIR) {\n      sdkVersionConfig = {};\n    } else {\n      throw new Error(`Unsupported SDK version: ${sdkVersion}`);\n    }\n  }\n  const { iosVersion, iosExpoViewUrl } = sdkVersionConfig;\n  const iosClientVersion = iosVersion ? iosVersion : versions.iosVersion;\n  return {\n    iosClientVersion,\n    iosExpoViewUrl,\n  };\n}\n\nasync function _getOrCreateTemplateDirectoryAsync(\n  context: StandaloneContext,\n  iosExpoViewUrl: string\n) {\n  if (context.type === 'service') {\n    return path.join(context.data.expoSourcePath, '..');\n  } else if (context.type === 'user') {\n    let expoRootTemplateDirectory;\n    if (process.env.EXPO_VIEW_DIR) {\n      // Only for testing\n      expoRootTemplateDirectory = process.env.EXPO_VIEW_DIR;\n    } else {\n      // HEY: if you need other paths into the extracted archive, be sure and include them\n      // when the archive is generated in `ios/pipeline.js`\n      expoRootTemplateDirectory = path.join(context.data.projectPath, 'temp-ios-directory');\n      if (!isDirectory(expoRootTemplateDirectory)) {\n        mkdirp.sync(expoRootTemplateDirectory);\n        console.log('Downloading iOS code...');\n        await Api.downloadAsync(iosExpoViewUrl, expoRootTemplateDirectory, {\n          extract: true,\n        });\n      }\n    }\n    return expoRootTemplateDirectory;\n  }\n}\n\nasync function _renameAndMoveProjectFilesAsync(\n  context: StandaloneContext,\n  projectDirectory: string,\n  projectName: string\n) {\n  // remove .gitignore, as this actually pertains to internal expo template management\n  try {\n    const gitIgnorePath = path.join(projectDirectory, '.gitignore');\n    if (fs.existsSync(gitIgnorePath)) {\n      rimraf.sync(gitIgnorePath);\n    }\n  } catch (e) {}\n\n  const filesToTransform = [\n    path.join('exponent-view-template.xcodeproj', 'project.pbxproj'),\n    path.join('exponent-view-template.xcworkspace', 'contents.xcworkspacedata'),\n    path.join(\n      'exponent-view-template.xcodeproj',\n      'xcshareddata',\n      'xcschemes',\n      'exponent-view-template.xcscheme'\n    ),\n  ];\n\n  let bundleIdentifier;\n  if (context.type === 'user') {\n    const exp = context.data.exp;\n    bundleIdentifier = exp.ios && exp.ios.bundleIdentifier ? exp.ios.bundleIdentifier : null;\n    if (!bundleIdentifier) {\n      throw new Error(`Cannot configure an ExpoKit workspace with no iOS bundle identifier.`);\n    }\n  } else if (context.type === 'service') {\n    bundleIdentifier = 'host.exp.Exponent';\n  }\n\n  await Promise.all(\n    filesToTransform.map(fileName =>\n      transformFileContentsAsync(path.join(projectDirectory, fileName), fileString => {\n        return fileString\n          .replace(/com.getexponent.exponent-view-template/g, bundleIdentifier)\n          .replace(/exponent-view-template/g, projectName);\n      })\n    )\n  );\n\n  // order of this array matters\n  const filesToMove = [\n    'exponent-view-template',\n    path.join(\n      'exponent-view-template.xcodeproj',\n      'xcshareddata',\n      'xcschemes',\n      'exponent-view-template.xcscheme'\n    ),\n    'exponent-view-template.xcodeproj',\n    'exponent-view-template.xcworkspace',\n  ];\n\n  filesToMove.forEach(async fileName => {\n    let destFileName = path.join(path.dirname(fileName), `${projectName}${path.extname(fileName)}`);\n    await spawnAsync('/bin/mv', [\n      path.join(projectDirectory, fileName),\n      path.join(projectDirectory, destFileName),\n    ]);\n  });\n\n  return;\n}\n\n// TODO: logic for when kernel sdk version is different from detached sdk version\nasync function _configureVersionsPlistAsync(\n  configFilePath: string,\n  standaloneSdkVersion: string,\n  isMultipleVersion: boolean\n) {\n  await IosPlist.modifyAsync(configFilePath, 'EXSDKVersions', versionConfig => {\n    if (isMultipleVersion) {\n      delete versionConfig.detachedNativeVersions;\n      // leave versionConfig.sdkVersions unchanged\n      // because the ExpoKit template already contains the list of supported versions.\n    } else {\n      versionConfig.sdkVersions = [standaloneSdkVersion];\n      versionConfig.detachedNativeVersions = {\n        shell: standaloneSdkVersion,\n        kernel: standaloneSdkVersion,\n      };\n    }\n    return versionConfig;\n  });\n}\n\n// TODO: logic for builds that support multiple RN versions.\nasync function _renderPodfileFromTemplateAsync(\n  context: StandaloneContext,\n  expoRootTemplateDirectory: string,\n  sdkVersion: string,\n  iosClientVersion: string\n) {\n  const { iosProjectDirectory, projectName } = getPaths(context);\n  const templatePodfilePath = path.join(\n    expoRootTemplateDirectory,\n    'template-files',\n    'ios',\n    'ExpoKit-Podfile'\n  );\n  let reactNativeDependencyPath;\n  if (context.type === 'user') {\n    reactNativeDependencyPath = path.relative(\n      iosProjectDirectory,\n      path.join(context.data.projectPath, 'node_modules', 'react-native')\n    );\n  } else if (context.type === 'service') {\n    reactNativeDependencyPath = path.join(\n      expoRootTemplateDirectory,\n      '..',\n      'react-native-lab',\n      'react-native'\n    );\n  } else {\n    throw new Error(`Unsupported context type: ${context.type}`);\n  }\n  let podfileSubstitutions = {\n    TARGET_NAME: projectName,\n    REACT_NATIVE_PATH: reactNativeDependencyPath,\n    EXPOKIT_TAG: `ios/${iosClientVersion}`,\n  };\n  if (process.env.EXPOKIT_TAG_IOS) {\n    console.log(`EXPOKIT_TAG_IOS: Using custom ExpoKit iOS tag...`);\n    podfileSubstitutions.EXPOKIT_TAG = process.env.EXPOKIT_TAG_IOS;\n  } else if (process.env.EXPO_VIEW_DIR) {\n    console.log('EXPO_VIEW_DIR: Using local ExpoKit source for iOS...');\n    podfileSubstitutions.EXPOKIT_PATH = path.relative(\n      iosProjectDirectory,\n      process.env.EXPO_VIEW_DIR\n    );\n  }\n  await renderPodfileAsync(\n    templatePodfilePath,\n    path.join(iosProjectDirectory, 'Podfile'),\n    podfileSubstitutions,\n    sdkVersion\n  );\n}\n\nasync function createDetachedAsync(context: StandaloneContext) {\n  let isMultipleVersion, standaloneSdkVersion;\n  if (context.type === 'user') {\n    standaloneSdkVersion = context.config.sdkVersion;\n    isMultipleVersion = false;\n  } else if (context.type === 'service') {\n    const { version } = await Versions.newestSdkVersionAsync();\n    standaloneSdkVersion = version;\n    isMultipleVersion = true;\n  }\n  const { iosProjectDirectory, projectName, supportingDirectory } = getPaths(context);\n  console.log(`Creating ExpoKit workspace at ${iosProjectDirectory}...`);\n\n  const { iosClientVersion, iosExpoViewUrl } = await _getVersionedExpoKitConfigAsync(\n    standaloneSdkVersion\n  );\n  const expoRootTemplateDirectory = await _getOrCreateTemplateDirectoryAsync(\n    context,\n    iosExpoViewUrl\n  );\n\n  // copy template workspace\n  console.log('Moving iOS project files...');\n  await Utils.ncpAsync(\n    path.join(expoRootTemplateDirectory, 'exponent-view-template', 'ios'),\n    iosProjectDirectory\n  );\n\n  console.log('Naming iOS project...');\n  await _renameAndMoveProjectFilesAsync(context, iosProjectDirectory, projectName);\n\n  console.log('Configuring iOS dependencies...');\n  // this configuration must happen prior to build time because it affects which\n  // native versions of RN we depend on.\n  await _configureVersionsPlistAsync(supportingDirectory, standaloneSdkVersion, isMultipleVersion);\n  // TODO: add multiple versions in service context\n  await _renderPodfileFromTemplateAsync(\n    context,\n    expoRootTemplateDirectory,\n    standaloneSdkVersion,\n    iosClientVersion\n  );\n\n  if (!process.env.EXPO_VIEW_DIR) {\n    if (context.type === 'user') {\n      rimrafDontThrow(expoRootTemplateDirectory);\n    }\n    await IosPlist.cleanBackupAsync(supportingDirectory, 'EXSDKVersions', false);\n  }\n\n  return;\n}\n\nfunction addDetachedConfigToExp(exp: any, context: StandaloneContext): any {\n  if (context.type !== 'user') {\n    console.warn(`Tried to modify exp for a non-user StandaloneContext, ignoring`);\n    return;\n  }\n  if (!exp) {\n    exp = {};\n  }\n  const { supportingDirectory } = getPaths(context);\n  exp.ios.publishBundlePath = path.relative(\n    context.data.projectPath,\n    path.join(supportingDirectory, 'shell-app.bundle')\n  );\n  exp.ios.publishManifestPath = path.relative(\n    context.data.projectPath,\n    path.join(supportingDirectory, 'shell-app-manifest.json')\n  );\n  return exp;\n}\n\n/**\n *  paths returned:\n *    iosProjectDirectory - root directory of an (uncompiled) xcworkspace and obj-c source tree\n *    projectName - xcworkspace project name normalized from context.config\n *    supportingDirectory - location of Info.plist, xib files, etc. during configuration.\n *      for an unbuilt app this is underneath iosProjectDirectory. for a compiled app it's just\n *      a path to the flat xcarchive.\n *    intermediatesDirectory - temporary spot to write whatever files are needed during the\n *      detach/build process but can be discarded afterward.\n */\nfunction getPaths(context: StandaloneContext) {\n  let iosProjectDirectory;\n  let projectName;\n  let supportingDirectory;\n  let intermediatesDirectory;\n  if (context.isAnonymous()) {\n    projectName = 'ExpoProject';\n  } else if (context.config && context.config.name) {\n    let projectNameLabel = context.config.name;\n    projectName = projectNameLabel.replace(/[^a-z0-9_\\-]/gi, '-').toLowerCase();\n  } else {\n    throw new Error('Cannot configure an Expo project with no name.');\n  }\n  if (context.type === 'user') {\n    iosProjectDirectory = path.join(context.data.projectPath, 'ios');\n    supportingDirectory = path.join(iosProjectDirectory, projectName, 'Supporting');\n    intermediatesDirectory = path.join(iosProjectDirectory, 'ExpoKitIntermediates');\n  } else if (context.type === 'service') {\n    // compiled archive has a flat NSBundle\n    supportingDirectory = context.data.archivePath;\n    iosProjectDirectory = context.build.ios.workspaceSourcePath;\n    intermediatesDirectory = path.join(iosProjectDirectory, '..', 'intermediates');\n  } else {\n    throw new Error(`Unsupported StandaloneContext type: ${context.type}`);\n  }\n  return {\n    intermediatesDirectory,\n    iosProjectDirectory,\n    projectName,\n    supportingDirectory,\n  };\n}\n\nexport { addDetachedConfigToExp, createDetachedAsync, getPaths };\n"],"sourceRoot":"/xdl/src"}